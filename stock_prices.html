<!DOCTYPE html>

<html>
	<head>
		<title>Stock Prices</title>
	</head>
	<body style="background-color:lightgrey;font-family:Arial Black">
	
	<pre>
# Clear Console (equivalent of Ctrl + L)
cat("\014")

# Load packages or install if not already installed
if (!require("RSQLite")) {
  install.packages("RSQLite")
  library(RSQLite)
} 

if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
} 

if (!require("directlabels")) {
  install.packages("directlabels")
  library(directlabels)
} 

if (!require("ggthemes")) {
  install.packages("ggthemes")
  library(ggthemes)
} 

if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
} 

if (!require("sqldf")) {
  install.packages("sqldf")
  library(sqldf)
} 

# Connect to SQLite Database called test.db
connection <- dbConnect(SQLite(), "test.db")

allCompanies <- dbGetQuery(connection, "SELECT * FROM Test")

techCompanies <- sqldf("SELECT * FROM allCompanies WHERE c1='Tech' AND z1=(SELECT MAX(z1) FROM allCompanies)")

retailCompanies <- sqldf("SELECT * FROM allCompanies WHERE c1='Retail' AND z1=(SELECT MAX(z1) FROM allCompanies)")

financeCompanies <- sqldf("SELECT * FROM allCompanies WHERE c1='Finance' AND z1=(SELECT MAX(z1) FROM allCompanies)")

energyCompanies <- sqldf("SELECT * FROM allCompanies WHERE c1='Energy' AND z1=(SELECT MAX(z1) FROM allCompanies)")

techCompaniesHistorical <- sqldf("SELECT * FROM allCompanies WHERE c1='Tech'")

retailCompaniesHistorical <- sqldf("SELECT * FROM allCompanies WHERE c1='Retail'")

financeCompaniesHistorical <- sqldf("SELECT * FROM allCompanies WHERE c1='Finance'")

energyCompaniesHistorical <- sqldf("SELECT * FROM allCompanies WHERE c1='Energy'")

tickerNames <- dbGetQuery(connection, "SELECT DISTINCT t1 FROM Test")

# Call Queries
techCompanies
retailCompanies
financeCompanies
energyCompanies

dbDisconnect(connection)

# Calculate R Squared for EPS vs Price Plots
calcRsqr <- function(industry){
  reg <- lm(industry[,4] ~ industry[,5])
  rsqr <- summary(reg)$r.squared
  return(rsqr)
}

# Calculate R Squared for PE vs Price Plots
calcRsqrPE <- function(industry){
  reg <- lm(industry[,4] ~ industry[,7])
  rsqr <- summary(reg)$r.squared
  return(rsqr)
}

# Calculate p-value for EPS vs Price Plots
calcPval <- function(industry){
  reg <- lm(industry[,4] ~ industry[,5])
  pval <- summary(reg)$coefficients[2,4]
  return(pval)
}

# Calculate Minimum EPS for formatting 
calcMinEPS <- function(industry){
  if(min(industry[,5])<0){
    minEPS <- min(industry[,5])*1.25} 
  else{minEPS <- 0}
  return(minEPS)
}

# Calculate Maximum EPS for formatting 
calcMaxEPS <- function(industry){
  maxEPS <- max(industry[,5])*1.25
  return(maxEPS)
}

# Calculate Minimum Price for formatting 
calcMinPrice <- function(industry){
  if(min(industry[,4])<0){
    minEPS <- min(industry[,4])*1.25} 
  else{minEPS <- 0}
  return(minEPS)
}

# Calculate Maximum Price for formatting
calcMaxPrice <- function(industry){
  maxEPS <- max(industry[,4])*1.25
  return(maxEPS)
}

priceBarplot <- function(industry){
  title <- paste("Stock Prices\\prices", industry[2,6], ".png", sep='')
  png(title, width=1000, height=500, type="cairo")
  mypalette<-brewer.pal(n=9,name="Blues")
  newpar <- par(oma=c(0,1,0,0))
  par(bg="azure4")
  xx <- barplot(industry[,4], names.arg=industry[,1], col=mypalette,
                ylab="High Price", xlab="Ticker Symbol",
                main=paste("High Prices of", industry[2,6], "Companies\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
                ylim=c(calcMinPrice(industry), calcMaxPrice(industry)))
  text(x=xx, y=industry[,4], label=round(industry[,4], digits=2), pos=3)
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "azure3")
  xx <- barplot(industry[,4], names.arg=industry[,1], col=mypalette,
                ylab="High Price", xlab="Ticker Symbol",
                main=paste("High Prices of", industry[2,6], "Companies\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
                ylim=c(calcMinPrice(industry), calcMaxPrice(industry)), add=TRUE)
  text(x=xx, y=industry[,4], label=round(industry[,4], digits=2), pos=3)
  dev.off()
}

epsBarplot <- function(industry){
  title <- paste("Stock Prices\\eps", industry[2,6], ".png", sep='')
  png(title, width=1000, height=500, type="cairo")
  mypalette <- brewer.pal(n=9, name="Reds")
  par(bg="azure4")
  xx <- barplot(industry[,5], names=industry[,1], col=mypalette,
                ylab="EPS", xlab="Ticker Symbol",
                main=paste("EPS of", industry[2,6], "Companies\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
                ylim=c(calcMinEPS(industry), calcMaxEPS(industry)))
  text(x=xx, y=industry[,5], label=round(industry[,5], digits=2), pos=3)
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "azure3")
  xx <- barplot(industry[,5], names=industry[,1], col=mypalette,
                ylab="EPS", xlab="Ticker Symbol",
                main=paste("EPS of", industry[2,6], "Companies\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
                ylim=c(calcMinEPS(industry), calcMaxEPS(industry)), add=TRUE)
  text(x=xx, y=industry[,5], label=round(industry[,5], digits=2), pos=3)
  abline(h=0)
  dev.off()
}

priceBoxplot <- function(industry){
  title <- paste("Stock Prices\\priceBoxplot", industry[2,6], ".png", sep='')
  print(title)
  png(title, width=1000, height=500, type="cairo")
  newpar <- par(oma=c(0,1,0,0))
  par(bg="azure4")
  boxplot(industry[,4] ~ industry[,1], xlab="Ticker Symbol", ylab="Daily High Price",
          main=paste("Distribution of Daily High Prices for", industry[2,6], "Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
          col="firebrick", pch=16)
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "azure3")
  boxplot(industry[,4] ~ industry[,1], xlab="Ticker Symbol", ylab="Daily High Price",
          main=paste("Distribution of Daily High Prices for", industry[2,6], "Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
          col="firebrick", pch=16, add=TRUE)
  dev.off()
}

epsBoxplot <- function(industry){
  title <- paste("Stock Prices\\epsBoxplot", industry[2,6], ".png", sep='')
  print(title)
  png(title, width=1000, height=500, type="cairo")
  newpar <- par(oma=c(0,1,0,0))
  par(bg="azure4")
  boxplot(industry[,5] ~ industry[,1], xlab="Ticker Symbol", ylab="EPS",
          main=paste("Distribution of EPS for", industry[2,6], "Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
          col="firebrick", pch=16)
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "azure3")
  boxplot(industry[,5] ~ industry[,1], xlab="Ticker Symbol", ylab="EPS",
          main=paste("Distribution of EPS for", industry[2,6], "Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y")),
          col="firebrick", pch=16, add=TRUE)
  dev.off()
}

epsPriceScatter <- function(industry){
  title <- paste("Stock Prices\\epsScatter", industry[2,6], ".png", sep='')
  png(title, width=1000, height=500, type="cairo")
  par(bg="steelblue")
  plot(industry[,5], industry[,4], main=paste("EPS vs High Price for ", industry[2,6], " Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y"), sep=''),ylab="High Price", xlab=paste("EPS\nR Squared=", round(calcRsqr(industry), digits=2), ", p-value=", round(calcPval(industry), digits=6), sep=''),col="Black", pch=16)
  reg <- lm(industry[,4] ~ industry[,5])
  #legend("topright", legend="Hello")
  abline(reg, col="Red")
  grid(col="darkgrey")
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "whitesmoke")
  par(new=TRUE)
  plot(industry[,5], industry[,4], main=paste("EPS vs High Price for ", industry[2,6], " Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y"), sep=''),ylab="High Price", xlab=paste("EPS\nR Squared=", round(calcRsqr(industry), digits=2), ", p-value=", round(calcPval(industry), digits=6), sep=''),col="Black", pch=16)
  reg <- lm(industry[,4] ~ industry[,5])
  #legend("topright", legend="Hello")
  abline(reg, col="Red")
  grid(col="darkgrey")
  dev.off()
}

pePriceScatter <- function(industry){
  title <- paste("Stock Prices\\peScatter", industry[2,6], ".png", sep='')
  png(title, width=1000, height=500, type="cairo")
  par(bg="steelblue")
  plot(industry[,7], industry[,4], main=paste("PE vs High Price for ", industry[2,6], " Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y"), sep=''),ylab="High Price", xlab=paste("PE\nR Squared=", round(calcRsqrPE(industry), digits=2), sep=''),col="Black", pch=16)
  reg <- lm(industry[,4] ~ industry[,7])
  #legend("topright", legend="Hello")
  abline(reg, col="Red")
  grid(col="darkgrey")
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "whitesmoke")
  par(new=TRUE)
  plot(industry[,7], industry[,4], main=paste("PE vs High Price for ", industry[2,6], " Industry\nRun Date: ", format(Sys.time(), format="%B %d %Y"), sep=''),ylab="High Price", xlab=paste("PE\nR Squared=", round(calcRsqrPE(industry), digits=2), sep=''),col="Black", pch=16)
  reg <- lm(industry[,4] ~ industry[,7])
  #legend("topright", legend="Hello")
  abline(reg, col="Red")
  grid(col="darkgrey")
  dev.off()
}

priceLineGraph <- function(ticker){
  company <- allCompanies[allCompanies$t1==ticker,]
  company$z1 <- as.Date(company$z1)
  png(paste("Stock Prices\\Trend\\trend", ticker, ".png", sep=''), width=1000, height=500,type="cairo")
  par(bg="steelblue")
  xx <- plot(company$z1, company$a1, xlab="Date", ylab="High Price", main=paste("High Prices over time for ", ticker, sep=''), pch=16, type="o")
  rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "whitesmoke")
  par(new=TRUE)
  xx <- plot(company$z1, company$a1, xlab="Date", ylab="High Price", main=paste("High Prices over time for ", ticker, sep=''), pch=16, type="o")
  dev.off()
}

# Order By Daily High Price
techCompanies <- sqldf("SELECT * FROM techCompanies ORDER BY a1")
retailCompanies <- sqldf("SELECT * FROM retailCompanies ORDER BY a1")
financeCompanies <- sqldf("SELECT * FROM financeCompanies ORDER BY a1")
energyCompanies <- sqldf("SELECT * FROM energyCompanies ORDER BY a1")

priceBarplot(techCompanies)
priceBarplot(retailCompanies)
priceBarplot(financeCompanies)
priceBarplot(energyCompanies)

# Ordery By EPS
techCompanies <- sqldf("SELECT * FROM techCompanies ORDER BY b1")
retailCompanies <- sqldf("SELECT * FROM retailCompanies ORDER BY b1")
financeCompanies <- sqldf("SELECT * FROM financeCompanies ORDER BY b1")
energyCompanies <- sqldf("SELECT * FROM energyCompanies ORDER BY b1")

epsBarplot(techCompanies)
epsBarplot(retailCompanies)
epsBarplot(financeCompanies)
epsBarplot(energyCompanies)


priceBoxplot(techCompaniesHistorical)
priceBoxplot(retailCompaniesHistorical)
priceBoxplot(financeCompaniesHistorical)
priceBoxplot(energyCompaniesHistorical)

epsBoxplot(techCompaniesHistorical)
epsBoxplot(retailCompaniesHistorical)
epsBoxplot(financeCompaniesHistorical)
epsBoxplot(energyCompaniesHistorical)

epsPriceScatter(techCompaniesHistorical)
epsPriceScatter(retailCompaniesHistorical)
epsPriceScatter(financeCompaniesHistorical)
epsPriceScatter(energyCompaniesHistorical)

pePriceScatter(techCompaniesHistorical)
pePriceScatter(retailCompaniesHistorical)
pePriceScatter(financeCompaniesHistorical)
pePriceScatter(energyCompaniesHistorical)

tickerNames <- as.vector(tickerNames[,1])

sapply(tickerNames, priceLineGraph)

print(Sys.time())

	</pre>
	
	</body>
</html>